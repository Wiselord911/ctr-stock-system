{% extends "base.html" %}
{% block content %}
<div class="py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">เบิกออกสินค้า</h2>
  </div>

  <div class="card p-3 mb-4">
    <form method="post" action="{{ url_for('issue_post') }}" id="issueForm" novalidate>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">ค้นหาสินค้า</label>
          <input type="text" class="form-control" id="item_search" placeholder="พิมพ์ชื่อสินค้า..." autocomplete="off" list="item_datalist">
          <datalist id="item_datalist"></datalist>
          <input type="hidden" name="item_id" id="item_id">
          <div class="form-text" id="item_hint">เลือกจากรายการที่แนะนำ</div>
        </div>
        <div class="col-md-3">
          <label class="form-label">จำนวน</label>
          <input type="number" class="form-control" name="quantity" min="1" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">หมายเหตุ</label>
          <input type="text" class="form-control" name="note">
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-danger">บันทึกการเบิกออก</button>
      </div>
    </form>
  </div>

  <div class="card p-3">
    <h5 class="mb-3">ประวัติการเบิกออกล่าสุด</h5>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>สินค้า</th>
            <th>ประเภท</th>
            <th class="text-end">จำนวน</th>
            <th>โดย</th>
            <th>เมื่อ</th>
          </tr>
        </thead>
        <tbody>
          {% if issue_logs and issue_logs|length %}
            {% for r in issue_logs %}
              <tr>
                <td>{{ r.item_name }}</td>
                <td>{{ r.category_name or '-' }}</td>
                <td class="text-end">{{ r.quantity }}</td>
                <td>{{ r.actor_name or '-' }}</td>
                <td>{{ r.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="5" class="text-center text-muted py-4">ยังไม่มีข้อมูล</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
const input = document.getElementById('item_search');
const datalist = document.getElementById('item_datalist');
const hiddenId = document.getElementById('item_id');
const hint = document.getElementById('item_hint');

let lastQ = '';
input.addEventListener('input', async (e) => {
  const q = (e.target.value || '').trim();
  hiddenId.value = '';
  hint.textContent = 'เลือกจากรายการที่แนะนำ';
  if (q.length === 0) { datalist.innerHTML=''; return; }
  if (q === lastQ) return;
  lastQ = q;
  try {
    const res = await fetch(`/api/items?q=${encodeURIComponent(q)}&limit=30`);
    const items = await res.json();
    datalist.innerHTML = items.map(it =>
      `<option value="${it.name}" data-id="${it.id}">${it.name} (${it.category || 'ไม่ระบุ'}) | คงเหลือ ${it.balance}</option>`
    ).join('');
  } catch {}
});

input.addEventListener('change', () => {
  const opts = Array.from(datalist.options || []);
  const opt = opts.find(o => o.value === input.value);
  if (opt && opt.dataset.id) {
    hiddenId.value = opt.dataset.id;
    hint.textContent = `เลือก: ${input.value}`;
  } else {
    hiddenId.value = '';
    hint.textContent = 'ไม่พบในรายการที่แนะนำ';
  }
});
</script>
{% endblock %}
